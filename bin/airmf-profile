#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AIRMF_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

usage() {
  cat <<EOF
Usage: airmf-profile <mode> [args...]
   or: airmf-profile --<mode> [args...]

Modes:
  cpu         CPU workflow profiling.
  gpu         GPU workflow profiling.
  storage     Storage workflow profiling.

All arguments after the mode are passed directly to the selected backend.
Run 'airmf-profile <mode> --help' for backend-specific options.

Examples:
  airmf-profile cpu --outfile cpu_report.csv -- my_command [args...]
  airmf-profile gpu --outfile gpu_report.csv -- my_command [args...]
  airmf-profile storage --outfile storage_report.csv -- my_command [args...]
EOF
}

if [[ $# -lt 1 ]]; then
  echo "airmf-profile: missing mode (cpu|gpu|storage)" >&2
  usage
  exit 2
fi

MODE="$1"
shift || true

case "$MODE" in
  cpu|--cpu)
    BACKEND="$AIRMF_ROOT/workflow_profiling/profile_workflow_cpu.sh"
    ;;
  gpu|--gpu)
    BACKEND="$AIRMF_ROOT/workflow_profiling/profile_workflow_gpu.sh"
    ;;
  storage|--storage)
    BACKEND="$AIRMF_ROOT/workflow_profiling/profile_workflow_storage.sh"
    ;;
  -h|--help)
    usage
    exit 0
    ;;
  *)
    echo "airmf-profile: unknown mode: $MODE" >&2
    usage
    exit 2
    ;;
esac

if [[ ! -x "$BACKEND" ]]; then
  echo "airmf-profile: backend script not found or not executable:" >&2
  echo "  $BACKEND" >&2
  exit 1
fi

# Hand off completely; backend owns all argument parsing
echo "Executing backend: $BACKEND $@"
exec "$BACKEND" "$@"
